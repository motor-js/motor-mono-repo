import e,{useContext as t,useState as r,useEffect as o,useRef as n,useReducer as a,useCallback as i}from"react";import s from"react-watermark-component";import l from"prop-types";import{jsx as q,jsxs as c}from"react/jsx-runtime";import u from"crypto-js/aes";import d from"crypto-js/enc-utf8";const p=e.createContext();function y(){return(y=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e}).apply(this,arguments)}function b(e,t){if(null==e)return{};var r,o,n={},a=Object.keys(e);for(o=0;o<a.length;o++)t.indexOf(r=a[o])>=0||(n[r]=e[r]);return n}const f=({config:e,header:t,body:r,bodySub:o,size:n,buttonText:a,backgroundColor:i,buttonFontColor:s,buttonColor:l,logo:u,logoHeight:d,logoWidth:p,loginfontFamily:y})=>{const b=e.host,f=e.webIntId;return q("div",{style:{position:"fixed",top:0,left:0,zIndex:1040,width:"100vw",height:"100vh",backgroundColor:"rgba(105, 105, 105, 0.8)",display:"flex"},children:c("div",{style:{display:"flex",justifyContent:"center",flexDirection:"column",position:"relative",margin:.2,padding:"5px",backgroundColor:i,border:"1px solid gray",borderRadius:"8px",width:"30%",minWidth:"350px",top:"30%",left:"35%",alignSelf:"flex-start"},children:[q("div",{style:{fontFamily:y,width:"100%",display:"flex",boxSizing:"border-box",borderBottom:"solid 1px #ced4da",WebkitBoxPack:"center",WebkitJustifyContent:"center",msFlexPack:"center",justifyContent:"center",overflow:"visible",WebkitFlexDirection:"row",msFlexDirection:"row",flexDirection:"row",WebkitFlex:"0 0 auto",msFlex:"0 0 auto",flex:"0 0 auto"},children:q("div",{size:n,style:{padding:"0.6rem",fontSize:"18px"},children:u?q("img",{src:u,height:d,width:p,alt:"Logo"}):t})}),c("div",{style:{fontFamily:y,width:"100%",display:"flex",boxSizing:"border-box",padding:"0.8rem",WebkitAlignItems:"center",WebkitBoxAlign:"center",msFlexAlign:"center",alignItems:"center",WebkitBoxPack:"center",WebkitJustifyContent:"center",msFlexPack:"center",justifyContent:"center",overflow:"visible",WebkitFlexDirection:"column",msFlexDirection:"column",flexDirection:"column",WebkitFlex:"column",msFlex:"0 0 auto",flex:"0 0 auto"},children:[q("div",{style:{padding:"0.6rem",fontSize:"14px"},children:r}),q("div",{style:{padding:"0.6rem",fontSize:"14px"},children:o}),q("button",{style:{fontFamily:y,fontSize:"14px",cursor:"pointer",position:"relative",margin:"5px",backgroundColor:l,borderRadius:"8px",color:s,border:0,outline:"none",WebkitTransition:"none",transition:"none",padding:"0.7em 1.7em"},onClick:()=>{const e=new URL(`https://${b}/login`);e.searchParams.append("returnto",window.location.href),e.searchParams.append("qlik-web-integration-id",f),window.location.href=e},children:a})]})]})})},m=["config"],h=e=>{let{config:r}=e,o=b(e,m);const{errorCode:n}=t(p);return q("div",{style:{display:-1===n?"":"none"},children:r&&n&&q(f,y({config:r},o))})};h.propTypes={config:l.object,header:l.string,body:l.string,bodySub:l.string,size:l.oneOf(["tiny","small","medium","large","xlarge"]),buttonText:l.string,backgroundColor:l.string,buttonFontColor:l.string,buttonColor:l.string,logo:l.string,logoHeight:l.string,logoWidth:l.string,header:l.string,loginfontFamily:l.string},h.defaultProps={config:null,logo:null,logoHeight:null,logoWidth:null,header:"Welcome to your motor js mashup",body:"Please log on to access your application",bodySub:"",size:"medium",buttonText:"Login",backgroundColor:"white",buttonFontColor:"white",buttonColor:"#ff6961",loginfontFamily:"Inter,sans-serif"};const g=({header:e,body:t,size:r,buttonText:o,backgroundColor:n,buttonFontColor:a,buttonColor:i,loginfontFamily:s})=>q("div",{style:{position:"fixed",top:0,left:0,zIndex:1040,width:"100vw",height:"100vh",backgroundColor:"rgba(105, 105, 105, 0.8)",display:"flex"},children:c("div",{style:{display:"flex",justifyContent:"center",flexDirection:"column",position:"relative",margin:.2,padding:"5px",backgroundColor:n,border:"1px solid gray",borderRadius:"8px",width:"30%",minWidth:"350px",top:"30%",left:"35%",alignSelf:"flex-start"},children:[q("div",{style:{fontFamily:s,width:"100%",display:"flex",boxSizing:"border-box",borderBottom:"solid 1px #ced4da",WebkitBoxPack:"center",WebkitJustifyContent:"center",msFlexPack:"center",justifyContent:"center",overflow:"visible",WebkitFlexDirection:"row",msFlexDirection:"row",flexDirection:"row",WebkitFlex:"0 0 auto",msFlex:"0 0 auto",flex:"0 0 auto"},children:q("div",{size:r,style:{padding:"0.8rem",fontSize:"16px"},children:e})}),c("div",{focusable:!1,width:"100%",align:"center",direction:"column",padding:"0.8rem",children:[q("div",{size:r,style:{padding:"0.6rem",fontSize:"14px",fontFamily:s},children:t}),q("button",{style:{fontFamily:s,fontSize:"14px",cursor:"pointer",position:"relative",margin:"5px",backgroundColor:i,borderRadius:"8px",color:a,border:0,outline:"none",WebkitTransition:"none",transition:"none",padding:"0.7em 1.7em"},onClick:()=>location.reload(),children:o})]})]})}),S=require("enigma.js"),C=require("enigma.js/schemas/12.170.2.json"),D=require("enigma.js/sense-utilities");function w(e){const t=[{onRejected:function(e,t,r){return console.warn("Captured Request: Rejected",`Error Code: ${r.code} : ${r}`),r.code===C.enums.LocalizedErrorCode.LOCERR_GENERIC_ABORTED&&(t.tries=(t.tries||0)+1,console.warn(`Captured Request: Retry #${t.tries}`),t.tries<=3)?t.retry():r.code===C.enums.LocalizedErrorCode.LOCERR_GENERIC_INVALID_PARAMETERS||r.code===C.enums.LocalizedErrorCode.LOCERR_HC_MODAL_OBJECT_ERROR?r.code:(console.warn(r),this.Promise.reject(r))}}],[o,n]=r(!1),[a,i]=r(null),[s,l]=r(()=>{(async()=>{if(e&&e.qcs){const r=e.host,o=e.webIntId,n=(await fetch(`https://${r}/api/v1/csrf-token`,{mode:"cors",credentials:"include",headers:{"qlik-web-integration-id":o,"content-type":"application/json"}}).catch(e=>{console.log("caught failed fetch",e)})).headers.get("qlik-csrf-token");if(null==n)return console.log("Not logged in"),i(-1),-1;const a=S.create({schema:C,url:`wss://${r}/app/${e.appId}?qlik-web-integration-id=${o}&qlik-csrf-token=${n}`,createSocket:e=>new WebSocket(e),responseInterceptors:t});a.on("suspended",()=>{console.warn("Captured session suspended")}),a.on("error",()=>{console.warn("Captured session error")}),a.on("closed",()=>(console.warn("Session was closed"),i(-3),-3));const s=await a.open(),q=await s.openDoc(e.appId);return l(q),i(1),1}if(e){const r=D.buildUrl(e);try{const o=S.create({schema:C,url:r,responseInterceptors:t});o.on("suspended",()=>{console.warn("Captured session suspended")}),o.on("error",()=>{console.warn("Captured session error")}),o.on("closed",()=>(console.warn("Session was closed"),i(-3),-3));const n=await o.open(),a=await n.openDoc(e.appId);l(a),i(1)}catch(e){return console.warn("Captured Error",e),1003===e.code&&n("No engine. App Not found."),i(-2),-2}}})()},[]);return{engine:s,engineError:o,errorCode:a}}const x=["config"],L=e=>{let{config:r}=e,o=b(e,x);const n=t(p),a=w(r),{errorCode:i}=n||a;return q("div",{style:{display:-3===i?"":"none"},children:r&&i&&q(g,y({},o))})};function I({engine:e,children:t,licenseKey:n,config:a,logo:i,logoWidth:l,logoHeight:y,header:b,body:f,bodySub:m,size:g,buttonText:S,buttonFontColor:C,buttonColor:D,backgroundColor:x,loginfontFamily:I,NotConnectedheader:T,NotConnectedBody:O,NotConnectedButtonText:k}){const[E,F]=r(a),[N,j]=r(!0),B=e?{engine:e,engineError:null,errorCode:null}:w(E),v=n?function(e){var t;const r=[];for(t=1;t<101;t++)r.push("MotorLicense-"+t);var o=u.decrypt(e,"S@few/M0t0r").toString(d);return r.filter(e=>e==o)}(n):[];return o(()=>{j(v.length>0)},[n]),c(p.Provider,{value:B,children:[q(h,{config:E,logo:i,logoHeight:y,logoWidth:l,header:b,body:f,bodySub:m,size:g,backgroundColor:x,buttonText:S,buttonFontColor:C,buttonColor:D,loginfontFamily:I}),q(L,{config:E,header:T,body:O,size:g,buttonText:k,backgroundColor:x,buttonFontColor:C,buttonColor:D,loginfontFamily:I}),N?q("div",{children:t}):q(s,{waterMarkText:"Powered by Motor",openSecurityDefense:!0,securityAlarm:function(){console.error("start alarm!")},options:{chunkWidth:200,chunkHeight:90,textAlign:"left",textBaseline:"bottom",globalAlpha:.27,font:"16px Roboto sans-serif",rotateAngle:-.19,fillStyle:"#666"},children:t})]})}L.propTypes={header:l.string,body:l.string,size:l.oneOf(["tiny","small","medium","large","xlarge"]),buttonText:l.string,backgroundColor:l.string,buttonFontColor:l.string,buttonColor:l.string,loginfontFamily:l.string},L.defaultProps={header:"Connection to server lost",body:"Please reload the page to refresh the dashboard",size:"medium",buttonText:"Reload Page",backgroundColor:"white",buttonFontColor:"white",buttonColor:"#ff6961",loginfontFamily:"Inter,sans-serif"};const T=e=>e&&"object"==typeof e&&!Array.isArray(e),O=(e,...t)=>{if(!t.length)return e;const r=y({},e);return t.forEach(e=>{T(e)&&Object.keys(e).forEach(t=>{r[t]=T(e[t])?r[t]?O(r[t],e[t]):y({},e[t]):e[t]})}),r},k={qData:null,qRData:null,qLayout:null,selections:null};function E(e,t){const{payload:{qData:r,qRData:o,qLayout:n,selections:a},type:i}=t;switch(i){case"update":return y({},e,{qData:r,qLayout:n,selections:a});case"updateReducedData":return y({},e,{qRData:o});default:throw new Error}}const F={cols:null,qHyperCubeDef:null,qPage:{qTop:0,qLeft:0,qWidth:10,qHeight:1e3},qSortByAscii:1,qSortByLoadOrder:1,qInterColumnSortOrder:[],qSuppressZero:!1,qSortByExpression:0,qSuppressMissing:!0,qExpression:null,getQRData:!1,qSortByNumeric:-1,qColumnOrder:[],qCalcCondition:void 0,qOtherTotalSpec:""},N=e=>{const{cols:r,qHyperCubeDef:s,qPage:l,qSortByAscii:q,qSortByLoadOrder:c,qInterColumnSortOrder:u,qSuppressZero:d,qSortByNumeric:b,qSortByExpression:f,qSuppressMissing:m,qExpression:h,qColumnOrder:g,qCalcCondition:S,getQRData:C,qOtherTotalSpec:D}=O(F,e),w=n(!0),[x,L]=a(E,k),{qData:I,qRData:T,qLayout:N,selections:j}=x,{engine:B}=t(p)||{},v=n(null),A=n(l);let H;"object"==typeof D?H={qOtherMode:"OTHER_COUNTED",qOtherCounted:D.qOtherCount}:D?H={qOtherMode:"OTHER_COUNTED",qOtherCounted:"8"}:D||(H={qOtherMode:"OTHER_OFF",qOtherCounted:""});const R=i(()=>{const e={qInfo:{qType:"visualization"}};if(s){const t=s;return r&&r[1]&&(t.qMeasures[0].qDef={qDef:r[1]}),r&&r[0]&&(t.qDimensions[0].qDef.qFieldDefs=[r[0]]),e.qInfo.qType="HyperCube",e.qHyperCubeDef=t,e}const t=u||[],o=!!u;let n=0;const a=r.filter((e,r)=>{const a="string"==typeof e&&!e.startsWith("=")||"object"==typeof e&&e.qDef&&e.qDef.qFieldDefs||"object"==typeof e&&e.qLibraryId&&e.qType&&"dimension"===e.qType||"object"==typeof e&&!e.qField.startsWith("=");return a&&!o&&(t[r]=n,n+=1),a}).map(e=>"string"==typeof e?{qDef:{qFieldDefs:[e],qSortCriterias:[{qSortByAscii:q,qSortByLoadOrder:c}]},qNullSuppression:!0,qSuppressMissing:!0,qShowTotalsAbove:!0}:"object"!=typeof e||e.qLibraryId?"object"==typeof e&&e.qLibraryId?{qLibraryId:e.qLibraryId,qType:e.qType,qOtherTotalSpec:H,qOtherLabel:void 0!==D?D.qOtherLabel:"Others",qAttributeExpressions:[{qExpression:e.qCondBackgroundFormat,qLibraryId:"",qAttribute:!1,id:"cellBackgroundColor"},{qExpression:e.qCondTextFormat,qLibraryId:"",qAttribute:!1,id:"cellForegroundColor"},{qExpression:e.qCondChartColor,qLibraryId:"",qAttribute:!1,id:"colorTheme"}],qNullSuppression:!e.qNullSuppression||e.qNullSuppression,qSuppressMissing:!0,qShowTotalsAbove:!0}:e:{qDef:{qFieldDefs:[e.qField],qFieldLabels:[e.qLabel],qSortCriterias:e.qSortCriterias?[e.qSortCriterias]:[{qSortByLoadOrder:c,qSortByAscii:q}]},qOtherTotalSpec:H,qOtherLabel:void 0!==D?D.qOtherLabel:"Others",qAttributeExpressions:[{qExpression:e.qCondBackgroundFormat,qLibraryId:"",qAttribute:!1,id:"cellBackgroundColor"},{qExpression:e.qCondTextFormat,qLibraryId:"",qAttribute:!1,id:"cellForegroundColor"},{qExpression:e.qCondChartColor,qLibraryId:"",qAttribute:!1,id:"colorTheme"}],qNullSuppression:!e.qNullSuppression||e.qNullSuppression,qSuppressMissing:!0,qShowTotalsAbove:!0}),i=r.filter((e,r)=>{const a="string"==typeof e&&e.startsWith("=")||"object"==typeof e&&e.qDef&&e.qDef.qDef||"object"==typeof e&&e.qLibraryId&&e.qType&&"measure"===e.qType||"object"==typeof e&&e.qField.startsWith("=");return a&&!o&&(t[r]=n,n+=1),a}).map(e=>"string"==typeof e?{qDef:{qDef:e,qNumFormat:e.qNumFormat},qSortBy:{qSortByNumeric:b,qSortByExpression:f,qExpression:h,qSuppressMissing:m}}:"object"==typeof e?{qDef:{qDef:e.qField,qLabel:e.qLabel,qNumFormat:{qType:e.qNumType||"U",qUseThou:1,qFmt:e.qNumFmt,qDec:".",qThou:","}},qSortBy:{qSortByNumeric:b,qSortByExpression:f,qExpression:h,qSuppressMissing:m},qAttributeExpressions:[{qExpression:e.qCondBackgroundFormat,qLibraryId:"",qAttribute:!1,id:"cellBackgroundColor"},{qExpression:e.qCondTextFormat,qLibraryId:"",qAttribute:!1,id:"cellForegroundColor"},{qExpression:e.qCondChartColor,qLibraryId:"",qAttribute:!1,id:"colorTheme"}],qChartType:e.qChartType,qShowPoints:e.qShowPoints,qCurve:e.qCurve,qFillStyle:e.qFillStyle,qLegendShape:e.qLegendShape}:e);return e.qHyperCubeDef={qDimensions:a,qMeasures:i,qInterColumnSortOrder:u,qSuppressZero:d,qSuppressMissing:m,qColumnOrder:g,qCalcCondition:S},e},[r,h,s,u,q,f,c,m,d]),M=i(()=>v.current.getLayout(),[]),P=i(async()=>(await v.current.getHyperCubeData("/qHyperCubeDef",[A.current]))[0],[]),W=i(()=>async()=>{const{qWidth:e}=A.current,t={qTop:0,qLeft:0,qWidth:e,qHeight:Math.round(1e4/e)};return(await v.current.getHyperCubeReducedData("/qHyperCubeDef",[t],-1,"D1"))[0]},[]),z=i(async e=>{const t=await M(),r=await P();if(r&&w.current){const o=r.qMatrix.filter(e=>"S"===e[0].qState);e&&e.map((e,r)=>{t.qHyperCube.qMeasureInfo[r]&&(t.qHyperCube.qMeasureInfo[r].qChartType=e.qChartType,t.qHyperCube.qMeasureInfo[r].qShowPoints=e.qShowPoints,t.qHyperCube.qMeasureInfo[r].qCurve=e.qCurve,t.qHyperCube.qMeasureInfo[r].qFillStyle=e.qFillStyle,t.qHyperCube.qMeasureInfo[r].qLegendShape=e.qLegendShape)}),L({type:"update",payload:{qData:r,qLayout:t,selections:o}})}else w.current&&L({type:"update",payload:{qData:r,qLayout:t}});if(C){const e=await W();w.current&&L({type:"updateReducedData",payload:{qRData:e}})}},[P,M,C,W]),$=i(e=>{A.current=y({},A.current,e),z()},[z]),V=i(()=>v.current.beginSelections(["/qHyperCubeDef"]),[!0]),_=i(e=>v.current.endSelections(e),[]),K=i((e,t,r=!1)=>v.current.selectHyperCubeValues("/qHyperCubeDef",e,t,r),[]),U=i(e=>v.current.applyPatches(e),[]);return o(()=>{B&&(v.current||(async()=>{const e=R(),t=await B;v.current=await t.createSessionObject(e),v.current.on("changed",()=>{z(e.qHyperCubeDef.qMeasures)}),z(e.qHyperCubeDef.qMeasures)})())},[R,B,z]),o(()=>()=>w.current=!1,[]),{beginSelections:V,endSelections:_,qLayout:N,qData:I,qRData:T,changePage:$,selections:j,select:K,applyPatches:U}},j={qDoc:null,qObject:null,qData:null,listData:null,selections:null,selectionsId:null};function B(e,t){const{payload:{qData:r,listData:o,selections:n,selectionsId:a,qDoc:i},type:s}=t;switch(s){case"update":return y({},e,{qData:r,listData:o,selections:n,selectionsId:a});case"init":return y({},e,{qDoc:i});default:throw new Error}}const v={autoSortByState:1,qSortByAscii:1,qSortByLoadOrder:1,dimension:null,label:null,qListObjectDef:null,qPage:{qTop:0,qLeft:0,qWidth:1,qHeight:1e4}},A=e=>{const{qPage:r,dimension:s,qListObjectDef:l,qSortByAscii:q,qSortByLoadOrder:c,autoSortByState:u}=O(v,e),{engine:d}=t(p)||{},b=n(!0),[f,m]=a(B,j),{listData:h,selections:g,selectionsId:S}=f,C=n(null),D=n(r),w=i((e=0)=>{const t={qInfo:{qType:"visualization"}};if(l)t.qListObjectDef=l;else{const r=s.filter(e=>"string"==typeof e&&!e.startsWith("=")||"object"==typeof e&&e.qDef&&e.qDef.qFieldDefs||"object"==typeof e&&e.qLibraryId&&e.qType&&"dimension"===e.qType).map(e=>"string"==typeof e?{qDef:{qFieldDefs:[e],qSortCriterias:[{qSortByLoadOrder:c,qSortByAscii:q}]}}:e);t.qListObjectDef=y({},{qLibraryId:"object"==typeof s[0]&&s[0].qLibraryId?s[0].qLibraryId:""},r[e],{qShowAlternatives:!0,qAutoSortByState:{qDisplayNumberOfRows:u}})}return t},[u,s,l,q,c]),x=i(async()=>(await C.current.getListObjectData("/qListObjectDef",[D.current]))[0],[]),L=i(async e=>{if(!h){if(!e)return null;let t=[];e.qMatrix.map((e,r)=>{t.push({key:e[0].qElemNumber,text:void 0!==e[0].qText?e[0].qText:"undefined",number:e[0].qNumber,state:e[0].qState,value:void 0!==e[0].qText?e[0].qText:"undefined",label:void 0!==e[0].qText?e[0].qText:"undefined"})});const r=t&&t.filter(e=>"S"===e.state);return{_selId:r&&r.map(e=>e.key),_selections:r,_listData:t}}},[h]),I=i(async()=>{const e=await x(),{_selId:t,_selections:r,_listData:o}=await L(e);e&&b.current?m({type:"update",payload:{listData:o,selections:r,selectionsId:t}}):b.current&&m({type:"update",payload:{listData:o}})},[x,L]),T=i(e=>{D.current=y({},D.current,e),I()},[I]),k=i((e,t=!0,r=!1)=>C.current.selectListObjectValues("/qListObjectDef",e,t,r),[]),E=i(e=>C.current.searchListObjectFor("/qListObjectDef",e),[]),F=i((e=!1)=>C.current.acceptListObjectSearch("/qListObjectDef",!0,e),[]),N=i(e=>C.current.applyPatches(e),[]),A=i(()=>C.current.clearSelections("/qListObjectDef"),[]);return o(()=>{d&&!C.current&&(async()=>{const e=w(),t=await d;C.current=await t.createSessionObject(e),b.current&&m({type:"init",payload:{qDoc:t}}),C.current.on("changed",()=>{I()}),I()})()},[w,d,I]),o(()=>()=>b.current=!1,[]),{listData:h,changePage:T,select:k,beginSelections:async()=>{await f.qDoc.abortModal(!0),await C.current.beginSelections(["/qListObjectDef"])},endSelections:async e=>{await C.current.endSelections(e)},searchListObjectFor:E,acceptListObjectSearch:F,applyPatches:N,selections:g,selectionsId:S,clearSelections:A,motorListProps:{clearSelections:A,selections:g,select:k}}},H=e=>e.qMeasureInfo.map((e,t)=>e.qFallbackTitle),R=e=>e.qDimensionInfo.map((e,t)=>e.qFallbackTitle),M=e=>{const{qDimensionInfo:t,qMeasureInfo:r}=e.qHyperCube||e.qListObject,o=()=>{(Array.isArray(t)?t:[t]).forEach(e=>{e.qError&&console.error("There is an issue with your dimension. Please fix this in order to receive the correct data. ",e.qError)})},n=()=>{r.forEach(e=>{isNaN(e.qMax)&&isNaN(e.qMin)&&console.error("There is an issue with your measure. It is not returning any data.")})};t&&r?(o(),n()):t&&!r?o():!t&&r&&n()},P={qData:null,qRData:null,qLayout:null,selections:null};function W(e,t){const{payload:{title:r,subTitle:o,metrics:n,qData:a,mData:i,nameKey:s,valueKey:l,qListData:q,dataList:c,dataKeys:u,qRData:d,qLayout:p,selections:b},type:f}=t;switch(f){case"update":return y({},e,{title:r,subTitle:o,metrics:n,qData:a,mData:i,nameKey:s,valueKey:l,qListData:q,dataList:c,dataKeys:u,qLayout:p,selections:b});case"updateReducedData":return y({},e,{qRData:d});default:throw new Error}}const z={cols:[],qLists:null,qHyperCubeDef:null,qPage:{qTop:0,qLeft:0,qWidth:10,qHeight:1e3},qSortByAscii:1,qSortByLoadOrder:1,qInterColumnSortOrder:[],qSuppressZero:!1,qSortByExpression:0,qSuppressMissing:!0,qExpression:null,getQRData:!1,qSortByNumeric:-1,qColumnOrder:[],qCalcCondition:void 0,qTitle:null,qSubTitle:null,qMetrics:null,qOtherTotalSpec:""},$=e=>{const{cols:s,qLists:l,qTitle:q,qSubTitle:c,qMetrics:u,qHyperCubeDef:d,qPage:b,qSortByAscii:f,qSortByLoadOrder:m,qInterColumnSortOrder:h,qSuppressZero:g,qSortByNumeric:S,qSortByExpression:C,qSuppressMissing:D,qExpression:w,qColumnOrder:x,qCalcCondition:L,getQRData:I,qOtherTotalSpec:T}=O(z,e),k=n(!0),[E,F]=a(W,P),{title:N,subTitle:j,metrics:B,qData:v,mData:A,nameKey:$,valueKey:V,qListData:_,dataList:K,dataKeys:U,qRData:G,qLayout:J,selections:Z}=E,{engine:Q}=t(p)||{},X=n(null),Y=n(b),[ee,te]=r(),[re,oe]=r(Y.current.qHeight);let ne;"object"==typeof T?ne={qOtherMode:"OTHER_COUNTED",qOtherCounted:T.qOtherCount}:T?ne={qOtherMode:"OTHER_COUNTED",qOtherCounted:"8"}:T||(ne={qOtherMode:"OTHER_OFF",qOtherCounted:""});const ae=i(()=>{const e={qInfo:{qType:"visualization"}};if(u&&u.map(t=>{e[t.qName]={[t.qType?t.qType:"qValueExpression"]:{qExpr:t.qExpr}}}),l&&(e.qListObjects=[],l.map(t=>{const r={qListObjectDef:{qStateName:"$",qLibraryId:"",qDef:{qFieldDefs:[Object.values(t)[0]],qFieldLabels:[Object.keys(t)[0]],qSortCriterias:[{qSortByLoadOrder:1}]},qInitialDataFetch:[{qTop:0,qHeight:1,qLeft:0,qWidth:1}]}};e.qListObjects.push(r)})),d){const t=d;return s&&s[1]&&(t.qMeasures[0].qDef={qDef:s[1]}),s&&s[0]&&(t.qDimensions[0].qDef.qFieldDefs=[s[0]]),e.qInfo.qType="HyperCube",e.qHyperCubeDef=t,e}const t=h||[],r=!!h;let o=0;const n=s&&s.filter((e,n)=>{const a="string"==typeof e&&!e.startsWith("=")||"object"==typeof e&&e.qDef&&e.qDef.qFieldDefs||"object"==typeof e&&e.qLibraryId&&e.qType&&"dimension"===e.qType||"object"==typeof e&&!e.qField.startsWith("=");return a&&!r&&(t[n]=o,o+=1),a}).map(e=>{if("string"==typeof e)return{qDef:{qFieldDefs:[e],qSortCriterias:[{qSortByAscii:f,qSortByLoadOrder:m}]},qNullSuppression:!0,qSuppressMissing:!0,qShowTotalsAbove:!0};if("object"==typeof e&&!e.qLibraryId){const t=[];if(e.qAttributeExpressions)for(const[r,o]of Object.entries(e.qAttributeExpressions))t.push({id:r,qExpression:o,qLibraryId:"",qAttribute:!1});return{qDef:{qFieldDefs:[e.qField],qFieldLabels:[e.qLabel],qSortCriterias:e.qSortCriterias?[e.qSortCriterias]:[{qSortByLoadOrder:m,qSortByAscii:f}]},qOtherTotalSpec:ne,qOtherLabel:void 0!==T?T.qOtherLabel:"Others",qAttributeExpressions:t,qNullSuppression:!e.qNullSuppression||e.qNullSuppression,qSuppressMissing:!0,qShowTotalsAbove:!0}}if("object"==typeof e&&e.qLibraryId){const t=[];if(e.qAttributeExpressions)for(const[r,o]of Object.entries(e.qAttributeExpressions))t.push({id:r,qExpression:o,qLibraryId:"",qAttribute:!1});return{qLibraryId:e.qLibraryId,qType:e.qType,qOtherTotalSpec:ne,qOtherLabel:void 0!==T?T.qOtherLabel:"Others",qAttributeExpressions:t,qNullSuppression:!e.qNullSuppression||e.qNullSuppression,qSuppressMissing:!0,qShowTotalsAbove:!0}}return e});if(n&&n.length>1){const t={qListObjectDef:{qStateName:"$",qLibraryId:"",qDef:{qFieldDefs:n[1].qDef.qFieldDefs,qFieldLabels:["multiDimDataKeys"],qSortCriterias:[{qSortByLoadOrder:1}]},qInitialDataFetch:[{qTop:0,qHeight:1,qLeft:0,qWidth:1}]}};void 0===e.qListObjects&&(e.qListObjects=[]),e.qListObjects.push(t)}const a=s&&s.filter((e,n)=>{const a="string"==typeof e&&e.startsWith("=")||"object"==typeof e&&e.qDef&&e.qDef.qDef||"object"==typeof e&&e.qLibraryId&&e.qType&&"measure"===e.qType||"object"==typeof e&&e.qField.startsWith("=");return a&&!r&&(t[n]=o,o+=1),a}).map(e=>{if("string"==typeof e)return{qDef:{qDef:e,qNumFormat:e.qNumFormat},qSortBy:{qSortByNumeric:S,qSortByExpression:C,qExpression:w,qSuppressMissing:D}};if("object"==typeof e){const t=[];if(e.qAttributeExpressions)for(const[r,o]of Object.entries(e.qAttributeExpressions))t.push({id:r,qExpression:o,qLibraryId:"",qAttribute:!1});return{qDef:{qDef:e.qField,qLabel:e.qLabel,qNumFormat:{qType:e.qNumType||"U",qUseThou:1,qFmt:e.qNumFmt,qDec:".",qThou:","}},qSortBy:{qSortByNumeric:S,qSortByExpression:C,qExpression:w,qSuppressMissing:D},qAttributeExpressions:t}}return e});return e.qHyperCubeDef={qDimensions:n,qMeasures:a,qInterColumnSortOrder:h,qSuppressZero:g,qSuppressMissing:D,qColumnOrder:x,qCalcCondition:L,qTitle:q},e},[s,q,w,d,h,f,C,m,D,g]),ie=i(()=>X.current.getLayout(),[]),se=i(async()=>{try{return(await X.current.getHyperCubeData("/qHyperCubeDef",[Y.current]))[0]}catch(e){te(e)}},[]),le=i(async e=>{const t=X.current;let r=Y.current,o=null,n=[];try{for(var a=0;a<e;a++)r=y({},r,{qTop:1e3*a}),o=await t.getHyperCubeData("/qHyperCubeDef",[r]),n.push(...o[0].qMatrix);return{qTails:o[0].qTails,qMatrix:n,qArea:o[0].qArea}}catch(e){te(e)}},[]),qe=i(async e=>await X.current.getListObjectData(`/qListObjects/${e}/qListObjectDef`,[Y.current])),ce=i(async e=>{if(e.qListObjects)return await Promise.all(e.qListObjects.map(async(e,t)=>qe(t)))},[]),ue=i(async e=>0===e.qHyperCube.qDimensionInfo.length?null:e.qHyperCube.qDimensionInfo[0].qFallbackTitle,[]),de=i(async e=>0===e.qHyperCube.qMeasureInfo.length?null:e.qHyperCube.qMeasureInfo[0].qFallbackTitle,[]),pe=i(()=>async()=>{const{qWidth:e}=Y.current,t={qTop:0,qLeft:0,qWidth:e,qHeight:Math.round(1e4/e)};return(await X.current.getHyperCubeReducedData("/qHyperCubeDef",[t],-1,"D1"))[0]},[]),ye=i(async(e,t)=>{if((0!==e.qHyperCube.qDimensionInfo.length||0!==e.qHyperCube.qMeasureInfo.length)&&t)return 1===e.qHyperCube.qDimensionInfo.length?function(e,t,r){const o=void 0!==t?t.qDimensionInfo.length:1,n=H(t),a=R(t);return e.qMatrix.map((e,i)=>{let s={},l={};return e.forEach((q,c)=>{if(c<o){const r=e[c].qAttrExps;void 0!==r&&r.qValues.forEach((e,r)=>{void 0!==e.qText&&(l[t.qDimensionInfo[c].qAttrExprInfo[r].id]="NaN"!==e.qNum?e.qNum:e.qText)})}else{const r=e[c].qAttrExps;void 0!==r&&r.qValues.forEach((e,r)=>{void 0!==e.qText&&(l[t.qMeasureInfo[c- -o].qAttrExprInfo[r].id]="NaN"!==e.qNum?e.qNum:e.qText)})}s=y({},s,c<o?{[a[c]]:e[c].qText,[`elemNumber${0!==c?c:""}`]:e[c].qElemNumber,key:i,label:e[c].qText}:{[n[c-o]]:r[c].qNumFormat||r[c].qNumType||r[c].qNumFmt?e[c].qText:"NaN"!==e[c].qNum?e[c].qNum:0,key:i},l)}),s})}(t,e.qHyperCube,s):function(e,t){const r=void 0!==t?t.qDimensionInfo.length:1;H(t);const o=R(t);let n=e.qMatrix[0][0].qText,a=[],i={};return e.qMatrix.map((e,t)=>{let s=null,l=null,q=null;e.forEach((t,o)=>{o<r&&0!==o?(s=e[o].qText,q=e[o].qElemNumber):0!==o&&(l=e[o].qNum)}),n!==e[0].qText?(0===Object.keys(i).length&&(i[o[0]]=e[0].qText,i.qElemNumber=e[0].qElemNumber,i[s]=l,i[`${s}-qElemNumber`]=q),a.push(i),i={}):(i[o[0]]=e[0].qText,i.qElemNumber=e[0].qElemNumber,i[s]=l,i[`${s}-qElemNumber`]=q,i.label=e[0].qText),n=e[0].qText}),a.push(i),a}(t,e.qHyperCube)},[]),be=i(async(e,t)=>e?e.filter(e=>"multiDimDataKeys"===Object.keys(e)[0])[0].multiDimDataKeys:t.map(e=>e.qFallbackTitle),[]),fe=i(async(e,t)=>{const r=[];return t.qListObjects?(t.qListObjects.map((t,o)=>{const n={},a=t.qListObject.qDimensionInfo.qFallbackTitle,i=e[o][0]?e[o][0].qMatrix.map(e=>e[0].qText):null;n[a]=i,r.push(n)}),r):null},[]),me=i(async e=>e.qHyperCube.qTitle,[]),he=i(async(e,t)=>{if(!t)return;let r={};return t.map(t=>{r[t.qName]=e[t.qName]}),r},[]),ge=i(async()=>{const e=await ie();await M(e);const t=await(Math.ceil(e.qHyperCube.qSize.qcy/re)<=1?se():le(Math.ceil(e.qHyperCube.qSize.qcy/re))),r=await ce(e),o=await ye(e,t),n=await ue(e),a=await de(e),i=await fe(r,e),s=await be(i,e.qHyperCube.qMeasureInfo),l=await me(e),q=c,d=await he(e,u);if(t&&k.current){const c=t.qMatrix.filter(e=>"S"===e[0].qState);F({type:"update",payload:{title:l,subTitle:q,qData:t,mData:o,nameKey:n,valueKey:a,qListData:r,dataList:i,dataKeys:s,metrics:d,qLayout:e,selections:c}})}else k.current&&F({type:"update",payload:{title:l,subTitle:q,metrics:d,qData:t,mData:o,nameKey:n,valueKey:a,qListData:r,dataList:i,dataKeys:s,qLayout:e}});if(I){const e=await pe();k.current&&F({type:"updateReducedData",payload:{qRData:e}})}},[se,ie,I,pe]),Se=i(e=>{Y.current=y({},Y.current,e),ge()},[ge]),Ce=i(()=>X.current.beginSelections(["/qHyperCubeDef"]),[!0]),De=i(e=>X.current.endSelections(e),[]),we=i((e,t,r=!1)=>X.current.selectHyperCubeValues("/qHyperCubeDef",e,t,r),[]),xe=i(e=>X.current.applyPatches(e),[]),Le=i(async(e,t)=>{await xe([{qOp:"replace",qPath:`/qHyperCubeDef/${e?"qMeasures":"qDimensions"}/0/qDef/${e?"qDef":"qFieldDefs"}`,qValue:JSON.stringify(e?t:[t])}])},[xe,J]);o(()=>{Q&&(X.current||(async()=>{const e=ae(),t=await Q;X.current=await t.createSessionObject(e),X.current.on("changed",()=>{ge(e.qHyperCubeDef.qMeasures)}),ge(e.qHyperCubeDef.qMeasures)})())},[ae,Q,ge]),o(()=>()=>k.current=!1,[]);const Ie={};return A&&(Ie.data=A),A&&(Ie.select=we),U&&0!==U.length&&(Ie.dataKeys=U),K&&(Ie.dataList=K),$&&(Ie.nameKey=$),V&&(Ie.valueKey=V),{beginSelections:Ce,endSelections:De,qLayout:J,qData:v,mData:A,qListData:_,dataList:K,handlerChange:Le,dataKeys:U,nameKey:$,dataSet:Ie,title:N,subTitle:j,metrics:B,qRData:G,changePage:Se,selections:Z,select:we,applyPatches:xe}};function V(e,t,r,o,n,a,i,s,l,q,c,u,d,p,y){const b={qInfo:{qType:"visualization"}};if(r){const t=r;return e&&e[1]&&(t.qMeasures[0].qDef={qDef:e[1]}),e&&e[0]&&(t.qDimensions[0].qDef.qFieldDefs=[e[0]]),b.qInfo.qType="HyperCube",b.qHyperCubeDef=t,b}const f=a||[],m=!!a;let h=0;const g=e.filter((e,t)=>{const r="string"==typeof e&&!e.startsWith("=")||"object"==typeof e&&e.qDef&&e.qDef.qFieldDefs||"object"==typeof e&&e.qLibraryId&&e.qType&&"dimension"===e.qType||Array.isArray(e.qField)||"object"==typeof e&&!e.qField.startsWith("=");return r&&!m&&(f[t]=h,h+=1),r}).map(e=>"string"==typeof e?{qDef:{qFieldDefs:[e],qSortCriterias:[{qSortByAscii:o,qSortByLoadOrder:n}]},qNullSuppression:!0,qSuppressMissing:!0,qShowTotalsAbove:!0}:"object"!=typeof e||e.qLibraryId?"object"==typeof e&&e.qLibraryId?{qLibraryId:e.qLibraryId,qType:e.qType,qOtherTotalSpec:y,qOtherLabel:void 0!==p?p.qOtherLabel:"Others",qAttributeExpressions:[{qExpression:e.qCondBackgroundFormat,qLibraryId:"",qAttribute:!1,id:"cellBackgroundColor"},{qExpression:e.qCondTextFormat,qLibraryId:"",qAttribute:!1,id:"cellForegroundColor"},{qExpression:e.qCondChartColor,qLibraryId:"",qAttribute:!1,id:"colorTheme"}],qNullSuppression:!e.qNullSuppression||e.qNullSuppression,qSuppressMissing:!0,qShowTotalsAbove:!0}:e:{qDef:{qGrouping:e.qGrouping||"N",qFieldDefs:Array.isArray(e.qField)?[...e.qField]:[e.qField],qFieldLabels:[e.qLabel],qSortCriterias:e.qSortCriterias?[e.qSortCriterias]:[{qSortByLoadOrder:n,qSortByAscii:o}]},qOtherTotalSpec:y,qOtherLabel:void 0!==p?p.qOtherLabel:"Others",qAttributeExpressions:[{qExpression:e.qCondBackgroundFormat,qLibraryId:"",qAttribute:!1,id:"cellBackgroundColor"},{qExpression:e.qCondTextFormat,qLibraryId:"",qAttribute:!1,id:"cellForegroundColor"},{qExpression:e.qCondChartColor,qLibraryId:"",qAttribute:!1,id:"colorTheme"}],qNullSuppression:!e.qNullSuppression||e.qNullSuppression,qSuppressMissing:!0,qShowTotalsAbove:!0}),S=e.filter((e,t)=>{const r="string"==typeof e&&e.startsWith("=")||"object"==typeof e&&e.qDef&&e.qDef.qDef||"object"==typeof e&&e.qLibraryId&&e.qType&&"measure"===e.qType||"object"==typeof e&&!Array.isArray(e.qField)&&e.qField.startsWith("=");return r&&!m&&(f[t]=h,h+=1),r}).map(e=>"string"==typeof e?{qDef:{qDef:e,qNumFormat:e.qNumFormat},qSortBy:{qSortByNumeric:s,qSortByExpression:l,qExpression:c,qSuppressMissing:q}}:"object"==typeof e?{qDef:{qDef:e.qField,qLabel:e.qLabel,qNumFormat:{qType:e.qNumType||"U",qUseThou:1,qFmt:e.qNumFmt,qDec:".",qThou:","}},qSortBy:{qSortByNumeric:s,qSortByExpression:l,qExpression:c,qSuppressMissing:q},qAttributeExpressions:[{qExpression:e.qCondBackgroundFormat,qLibraryId:"",qAttribute:!1,id:"cellBackgroundColor"},{qExpression:e.qCondTextFormat,qLibraryId:"",qAttribute:!1,id:"cellForegroundColor"},{qExpression:e.qCondChartColor,qLibraryId:"",qAttribute:!1,id:"colorTheme"}],qChartType:e.qChartType,qShowPoints:e.qShowPoints,qCurve:e.qCurve,qFillStyle:e.qFillStyle,qLegendShape:e.qLegendShape}:e);return b.qHyperCubeDef={qDimensions:g,qMeasures:S,qInterColumnSortOrder:a,qSuppressZero:i,qSuppressMissing:q,qColumnOrder:u,qCalcCondition:d,qTitle:t},b}const _={qData:null,qRData:null,qLayout:null,headerGroup:null,selections:null};function K(e,t){const{payload:{title:r,qData:o,dataSet:n,qRData:a,headerGroup:i,qLayout:s,selections:l},type:q}=t;switch(q){case"update":return y({},e,{title:r,qData:o,dataSet:n,headerGroup:i,qLayout:s,selections:l});case"updateReducedData":return y({},e,{qRData:a});default:throw new Error}}const U={cols:null,qHyperCubeDef:null,qTitle:null,qPage:{qTop:0,qLeft:0,qWidth:10,qHeight:300},sortCriteria:{qInterColumnSortOrder:[],qSortByAscii:1,qSortByLoadOrder:1,qExpression:null,qSortByNumeric:-1,qSortByExpression:0},qSuppressZero:!1,qSuppressMissing:!0,getQRData:!1,qColumnOrder:[],qCalcCondition:void 0,qOtherTotalSpec:""},G=e=>{const{cols:s,qTitle:l,qHyperCubeDef:q,qPage:c,sortCriteria:u,qSuppressZero:d,qSuppressMissing:b,qColumnOrder:f,qCalcCondition:m,getQRData:h,qOtherTotalSpec:g}=O(U,e),S=n(!0),[C,D]=a(K,_),{qInterColumnSortOrder:w,qSortByAscii:x,qSortByLoadOrder:L,qExpression:I,qSortByNumeric:T,qSortByExpression:k}=u,{title:E,qData:F,dataSet:N,qRData:j,headerGroup:B,qLayout:v,selections:A}=C,{engine:H}=t(p)||{},R=n(null),P=n(c),[W,z]=r(),[$,G]=r(P.current.qHeight),[J,Z]=r(0),Q=i(e=>{Z(e),ce({qTop:e*$})},[ce,$]);window.setPage=Q;const[X,Y]=r(0),ee=i(e=>{J>=e&&Q(0),Y(e)},[J,Q]),te=i(e=>{Q(e)},[Q]);let re;o(()=>{v&&F&&ee(Math.ceil(v.qHyperCube.qSize.qcy/$))},[v,F,$,Q,ee]),"object"==typeof g?re={qOtherMode:"OTHER_COUNTED",qOtherCounted:g.qOtherCount}:g?re={qOtherMode:"OTHER_COUNTED",qOtherCounted:"8"}:g||(re={qOtherMode:"OTHER_OFF",qOtherCounted:""});const oe=i(()=>V(s,l,q,x,L,w,d,T,k,b,I,f,m,g,re),[s,l,I,q,w,x,k,L,b,g,d]),ne=i(()=>R.current.getLayout(),[]),ae=i(async()=>{try{return(await R.current.getHyperCubeData("/qHyperCubeDef",[P.current]))[0]}catch(e){z(e)}},[]),ie=i(async e=>e.qHyperCube.qTitle,[]),se=i(()=>async()=>{const{qWidth:e}=P.current,t={qTop:0,qLeft:0,qWidth:e,qHeight:Math.round(1e4/e)};return(await R.current.getHyperCubeReducedData("/qHyperCubeDef",[t],-1,"D1"))[0]},[]),le=i(async(e,t,r)=>function(e,t,r){return e.qMatrix.map((e,t)=>{let o={};return e.forEach((n,a)=>{o=y({},o,{[r[a].dataKey]:{text:e[a].qText,number:e[a].qNum,elemNumber:e[a].qElemNumber,state:e[a].qState,attrExp:e[a].qAttrExps,columnId:a},key:t})}),o})}(t,0,r),[]),qe=i(async()=>{const e=await ne(),t=await ie(e);await M(e);const r=await ae(),o=await(e=>{let t=[],r=[];return(e=>{e.filter((e,t)=>"object"==typeof e&&e.qLibraryId&&e.qType&&"dimension"===e.qType||Array.isArray(e.qField)||"object"==typeof e&&!e.qField.startsWith("=")).map(e=>(t.push(e),e))})(e),(e=>{e.filter((e,t)=>"object"==typeof e&&e.qLibraryId&&e.qType&&"measure"===e.qType||"object"==typeof e&&!Array.isArray(e.qField)&&e.qField.startsWith("=")).map(e=>(r.push(e),e))})(e),t.concat(r)})(s),n=r&&await le(e,r,o),a=r&&await((e,t,r)=>e?[...e.qHyperCube.qDimensionInfo.map((e,r)=>({title:e.qFallbackTitle,dataIndex:t[r].dataKey,dataKey:t[r].dataKey,render:t[r].render,defaultSortDesc:"D"===e.qSortIndicator,qInterColumnIndex:r,qPath:`/qHyperCubeDef/qDimensions/${r}`,qSortIndicator:e.qSortIndicator,qReverseSort:e.qReverseSort,qGrandTotals:{qText:null,qNum:null},qColumnType:"dim"})),...e.qHyperCube.qMeasureInfo.map((r,o)=>({title:r.qFallbackTitle,dataIndex:t[e.qHyperCube.qDimensionInfo.length+o].dataKey,dataKey:t[e.qHyperCube.qDimensionInfo.length+o].dataKey,render:t[e.qHyperCube.qDimensionInfo.length+o].render,defaultSortDesc:"D"===r.qSortIndicator,qInterColumnIndex:o+e.qHyperCube.qDimensionInfo.length,qPath:`/qHyperCubeDef/qMeasures/${o}`,qSortIndicator:r.qSortIndicator,qReverseSort:r.qReverseSort,qGrandTotals:e.qHyperCube.qGrandTotalRow[o],qColumnType:"meas"}))]:[])(e,o);if(r&&S.current){const o=r.qMatrix.filter(e=>"S"===e[0].qState);D({type:"update",payload:{title:t,qData:r,dataSet:n,headerGroup:a,qLayout:e,selections:o}})}else S.current&&D({type:"update",payload:{title:t,qData:r,dataSet:n,headerGroup:a,qLayout:e}});if(h){const e=await se();S.current&&D({type:"updateReducedData",payload:{qRData:e}})}},[ae,ne,h,se]),ce=i(e=>{P.current=y({},P.current,e),qe()},[qe]),ue=i(()=>R.current.beginSelections(["/qHyperCubeDef"]),[!0]),de=i(e=>R.current.endSelections(e),[]),pe=i((e,t,r=!1)=>R.current.selectHyperCubeValues("/qHyperCubeDef",e,t,r),[]),ye=i(e=>R.current.applyPatches(e),[]),be=i(async e=>{"N"===e.qSortIndicator&&(e.qPath.includes("qDimensions")&&await ye([{qOp:"add",qPath:`${e.qPath}/qDef/qSortCriterias`,qValue:JSON.stringify([{qSortByLoadOrder:1}])}]),e.qPath.includes("qMeasures")&&await ye([{qOp:"add",qPath:`${e.qPath}/qSortBy`,qValue:JSON.stringify({qSortByLoadOrder:1})}])),await ye([{qOp:"replace",qPath:`${e.qPath}/qDef/qReverseSort`,qValue:JSON.stringify(!e.qReverseSort)},{qOp:"replace",qPath:"/qHyperCubeDef/qInterColumnSortOrder",qValue:JSON.stringify([...v.qHyperCube.qEffectiveInterColumnSortOrder].sort((t,r)=>t===e.qInterColumnIndex?-1:r===e.qInterColumnIndex?1:0))}]),Q(0)},[ye,v]);return o(()=>{H&&(R.current||(async()=>{const e=oe(),t=await H;R.current=await t.createSessionObject(e),R.current.on("changed",()=>{qe(e.qHyperCubeDef.qMeasures)}),qe(e.qHyperCubeDef.qMeasures)})())},[oe,H,qe]),o(()=>()=>S.current=!1,[]),{beginSelections:ue,endSelections:de,title:E,qLayout:v,qData:F,dataSet:N,headerGroup:B,handleSortChange:be,qRData:j,changePage:ce,selections:A,select:pe,applyPatches:ye,incrementPage:()=>{te(J+1)},decrementPage:()=>{te(0==J?X-1:J-1)},handlePageChange:te,page:J,pageSize:$,pages:X}},J=require("enigma.js"),Z=require("enigma.js/schemas/12.170.2.json"),Q=require("enigma.js/sense-utilities");function X(e){const t=[{onRejected:function(e,t,r){return console.warn("Captured Request: Rejected",`Error Code: ${r.code} : ${r}`),r.code===Z.enums.LocalizedErrorCode.LOCERR_GENERIC_ABORTED&&(t.tries=(t.tries||0)+1,console.warn(`Captured Request: Retry #${t.tries}`),t.tries<=3)?t.retry():r.code===Z.enums.LocalizedErrorCode.LOCERR_GENERIC_INVALID_PARAMETERS||r.code===Z.enums.LocalizedErrorCode.LOCERR_HC_MODAL_OBJECT_ERROR?r.code:(console.warn(r),this.Promise.reject(r))}}],[o,n]=r(!1),[a,i]=r(null),[s,l]=r(()=>{(async()=>{if(e&&e.qcs){const r=e.host,o=e.webIntId,n=(await fetch(`https://${r}/api/v1/csrf-token`,{mode:"cors",credentials:"include",headers:{"qlik-web-integration-id":o,"content-type":"application/json"}}).catch(e=>{console.log("caught failed fetch",e)})).headers.get("qlik-csrf-token");if(null==n)return console.log("Not logged in"),i(-1),-1;const a=J.create({schema:Z,url:`wss://${r}/app/${e.appId}?qlik-web-integration-id=${o}&qlik-csrf-token=${n}`,createSocket:e=>new WebSocket(e),responseInterceptors:t});a.on("suspended",()=>{console.warn("Captured session suspended")}),a.on("error",()=>{console.warn("Captured session error")}),a.on("closed",()=>(console.warn("Session was closed"),i(-3),-3));const s=await a.open(),q=await s.engineVersion(),c=await s.getDocList({}),u=await s.oSName(),d=await s.oSVersion();return l({global:s,docList:c,engineVersion:q,oSName:u,oSVersion:d}),i(1),1}if(e){const r=Q.buildUrl(e);try{const e=J.create({schema:Z,url:r,responseInterceptors:t});e.on("suspended",()=>{console.warn("Captured session suspended")}),e.on("error",()=>{console.warn("Captured session error")}),e.on("closed",()=>(console.warn("Session was closed"),i(-3),-3));const o=await e.open(),n=await o.engineVersion(),a=await o.getDocList({}),s=await o.oSName(),q=await o.oSVersion();l({global:o,docList:a,engineVersion:n,oSName:s,oSVersion:q}),i(1)}catch(e){return console.warn("Captured Error",e),1003===e.code&&n("No engine. App Not found."),i(-2),-2}}})()},[]);return y({},s,{globalError:o,errorCode:a})}const Y={qPage:{qTop:0,qLeft:0,qWidth:1,qHeight:1e3},cols:null,qHyperCubeDef:null,config:null},ee=e=>{const{cols:a,qHyperCubeDef:s}=O(Y,e),{engine:l}=t(p)||{},[q,c]=r(null),u=n(!0),d=n(null),y=i(()=>V(a,s),[a,s]);return o(()=>{l&&a&&(d.current||(async()=>{const e=y(),t=await l;d.current=await t.createSessionObject(e),c(await d.current.getLayout())})())},[y,l]),o(()=>()=>u.current=!1,[]),{clearSelections:()=>{l&&l.clearAll()},previousSelection:()=>{l&&l.back()},nextSelection:()=>{l&&l.forward()},qLayout:q,exportData:e=>{l.getObject(q.qInfo.qId).then(e=>{e.exportData("CSV_C","/qHyperCubeDef","Test","P").then(e=>{console.log(e.qUrl,e.qWarnings)})})},select:async(e,t)=>{const r=await l;(await r.getField(t)).select(e)},selectValues:async(e,t,r=!1)=>{const o=await e.map(e=>({qText:e})),n=await l;(await n.getField(t)).selectValues(o,r)},doReload:async(e,t)=>{(await l).doReload(e,t,!1)}}},te=({searchValue:e,dimensions:a,qCount:s,qGroupItemCount:l})=>{const[q,c]=r([]),[u,d]=r([]),y=n(!0),{engine:b}=t(p)||{};o(()=>{void 0===b||(async()=>{try{const t=await b,r=await t.searchResults({qSearchFields:a},[e],{qOffset:0,qCount:s,qGroupItemOptions:[{qGroupItemType:"FIELD",qOffset:0,qCount:l}]}),o=await r,n=await f(o),i=await m(n);c(n),d(i),y.current&&(c(n),d(i))}catch(e){console.warn(e)}})()},[b,e,s,l,a]),o(()=>()=>y.current=!1,[]);const f=e=>{let t=[],r={};return e.qSearchGroupArray.map(e=>{r.id=e.qId,r.dimension=e.qItems[0].qIdentifier,r.value=e.qItems[0].qItemMatches,t.push(r),r={}}),t},m=e=>{const t=[];let r={};return e.map(e=>{e.value.map(o=>{r.dimension=e.dimension,r.value=o.qText,t.push(r),r={}})}),t},h=i(t=>(async()=>{(await b).selectAssociations({qSearchFields:a,qContext:"CurrentSelections"},[e],t)})());return{groupResults:q,flatResults:u,flatSelect:i((e,t)=>(async()=>{const r=await b;(await r.getField(e)).select(t)})()),groupSelect:h}};let re=null,oe=null;const ne=()=>{const{engine:e}=t(p)||{},a=n(!0),[s,l]=r(null),[q,c]=r(null),u=i(async()=>{const e=await oe.getLayout(),t=await d(e);a.current&&(l(e),c(t))},[]),d=e=>e.qSelectionObject.qSelections;return o(()=>{void 0===e||(async()=>{re=await e,oe=await re.createSessionObject({qInfo:{qType:"SelectionObject"},qSelectionObjectDef:{}}),oe.on("changed",()=>{u()}),u()})()},[e,u]),o(()=>()=>a.current=!1,[]),{qLayout:s,selections:q,clearSelections:async(e,t)=>{if(e){const r=await re.getField(e);t?await r.toggleSelect(t):await r.clear()}else re.clearAll()}}};var ae={Uid:function(e){const t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",r=e||8;let o="";for(let e=0;e<r;e+=1)o+=t.charAt(Math.floor(Math.random()*t.length));return o},globals:{qlik:null,resize:null}};let ie,se;function le(e){const[t,o]=r(()=>{(async()=>{if(e&&e.qcs){const t={host:e.host,isSecure:e.secure,port:e.port||443,prefix:""!==e.prefix?`/${e.prefix}/`:"/",appId:e.appId,webIntegrationId:e.webIntId};try{await(async e=>{try{if(se)return void await se;const t=e.host,r=e.webIntId,o=document.createElement("link");o.rel="stylesheet",o.href=`https://${t}/resources/autogenerated/qlik-styles.css`,document.head.appendChild(o),o.loaded=new Promise(e=>{o.onload=()=>{e()}});const n=document.createElement("script");n.src=`https://${t}/resources/assets/external/requirejs/require.js`,n.onload=async()=>{window.require.config({baseUrl:`https://${t}/resources`,webIntegrationId:r})},document.body.appendChild(n),n.loaded=new Promise(e=>{n.onload=()=>{e()}}),se=Promise.all([o.loaded,n.loaded]),await se}catch(e){throw new Error(e)}})(t),window.require.config({baseUrl:`https://${t.host}/resources`,webIntegrationId:e.webIntId}),window.require(["js/qlik"],async e=>{const r=e.openApp(t.appId,t);return r.theme.get().then(e=>{e.apply()}),o(r),1})}catch(e){throw new Error(e)}}else try{await(async e=>{try{if(ie)return void await ie;const t=document.createElement("script"),r=""!==e.prefix?`/${e.prefix}`:"";t.src=(e.secure?"https://":"http://")+e.host+(e.port?`:${e.port}`:"")+r+"/resources/assets/external/requirejs/require.js",document.head.appendChild(t),t.loaded=new Promise(e=>{t.onload=()=>{e()}});const o=document.createElement("link");o.href=(e.secure?"https://":"http://")+e.host+(e.port?`:${e.port}`:"")+r+"/resources/autogenerated/qlik-styles.css",o.type="text/css",o.rel="stylesheet",document.head.appendChild(o),o.loaded=new Promise(e=>{o.onload=()=>{e()}}),ie=Promise.all([t.loaded,o.loaded]),await ie}catch(e){throw new Error(e)}})(e);const t=""!==e.prefix?`/${e.prefix}/`:"/";window.require.config({baseUrl:(e.secure?"https://":"http://")+e.host+(e.port?`:${e.port}`:"")+t+"resources",paths:{qlik:(e.secure?"https://":"http://")+e.host+(e.port?`:${e.port}`:"")+t+"resources/js/qlik"},config:{text:{useXhr:()=>!0}}}),new Promise(r=>{if(ae.globals.qlik){const r=ae.globals.qlik.openApp(e.appId,y({},e,{isSecure:e.secure,prefix:t}));r.theme.get().then(e=>{e.apply()}),o(r)}else window.require(["js/qlik"],r=>{ae.globals.qlik=r,ae.globals.resize=()=>{r.resize()};const n=r.openApp(e.appId,y({},e,{isSecure:e.secure,prefix:t}));return o(n),1})})}catch(e){throw new Error(e)}})()},[]);return{app:t}}const qe=()=>{const{engine:e}=t(p)||{},[n,a]=r(),i=async(t,r)=>{(await e).doReload(t,r,!1)};return o(()=>(async()=>{if(void 0===e);else{const t=await e,r=await t.getAppProperties();a(y({app:t,appProperties:r},r,{doReload:i}))}})(),[e]),y({},n)},ce=()=>{const{engine:e}=t(p)||{},[n,a]=r(null),[i,s]=r(null);return o(()=>(async()=>{if(e)try{const t=await e,r=await t.getAppLayout();a(y({appLayout:r},r))}catch(e){s(e)}})(),[e]),y({},n,{error:i})},ue={id:null,comment:void 0,numberPresentation:void 0,includeInBookmark:!1,definition:null},de=e=>{const a="string"==typeof e?e:e.name||null,{id:s,comment:l,numberPresentation:q,includeInBookmark:c,definition:u}=O(ue,e),{engine:d}=t(p)||{},[b,f]=r(null),[m,h]=r(null),[g,S]=r(null),C=n(null),D=(e,t,r,o,n,a)=>({qInfo:{qId:e,qType:"Variable"},qMetaDef:{},qName:t,qComment:r,qNumberPresentation:o,qIncludeInBookmark:n,qDefinition:a.toString()}),w=i(()=>C.current.getLayout(),[]),x=i(()=>C.current.getProperties(),[]),L=i(async e=>{const{qId:t,qName:r,qComment:o,qNumberPresentation:n,qIncludeInBookmark:a,qDefinition:i}=e;if(C.current){const e=await x(),s=await s.current.setProperties(D(t||e.qInfo.qId,r||e.qName,o||e.qComment,n||e.qNumberPresentation,a||e.qIncludeInBookmark,i.toString()||e.qDefinition.toString()));T(s.current)}},[]),I=i(async e=>{if(C.current){const t=await x(),r=await r.current.setProperties(D(t.qInfo.qId,t.qName,t.qComment,t.qNumberPresentation,t.qIncludeInBookmark,e.toString()));T(r.current)}},[]),T=i(async e=>{const t=await w();t.value="number"===t.qNum?t.qNum:t.qText,f(t),h(await x())},[]);return o(()=>{d&&(async()=>{await d;try{C.current=await(async(e,t,r,o,n,a)=>{const i=await d;let s;if(!e&&!t&&!a){const e=await i.createSessionObject({qInfo:{qId:"VL01",qType:"VariableList"},qVariableListDef:{qType:"variable"}});s=await e.getLayout(),f(s)}if(e&&!a&&(s=await i.getVariableById({qId:e})),t&&!a&&(s=await i.getVariableByName({qName:t})),t&&a)try{s=await i.getVariableByName({qName:t})}catch(l){s||(s=await i.createSessionVariable(D(e,t,r,o,n,a)),C.current=await s,T(C.current)),(g.code=18001)?S("Variable already exists"):S(l)}return s})(s,a,l,q,c,u),C.current.on("changed",()=>{T(C.current)}),T(C.current)}catch(e){S(-2===e.code?"Variable Not Found":e)}})()},[s,a,d]),b&&b.qVariableList&&(b.variableList=b.qVariableList.qItems),y({qLayout:b},b,{qProperties:m,setProperties:L,setValue:I,error:g})},pe=e=>{const{engine:a}=t(p)||{},[s,l]=r(null),[q,c]=r(null),u=n(null),d=i(e=>u.current.getBookmark({qId:e}),[]),b=async()=>{const e=await f(),t=e.map((e,t)=>({id:e.qInfo.qId,title:e.qMeta.title,description:e.qMeta.description,modifiedDate:e.qData.qBookmark.qUtcModifyTime}));l({bookmarks:e,bookmarkList:t})},f=i(()=>u.current.getBookmarks({qOptions:{qTypes:["bookmark"],qData:{}}})),m=i(async()=>{b()},[]);return o(()=>{a&&(u.current||(async()=>{const e=await a;try{u.current=e,u.current.on("changed",()=>{m()}),m()}catch(e){c(-2===e.code?"Bookmark Not Found":e)}})())},[a]),y({},s,{applyBookmark:async e=>{if(u.current&&u.current.applyBookmark({qId:e})){const t=await d(e),r=await t.getLayout();l(y({},s,{appliedBookmark:t,bookmarkInfo:r}))}},createBookmark:async(e,t,r=null)=>{const o=await u.current.createBookmark({qProp:{qInfo:{qId:r,qType:"bookmark"},qMetaDef:{title:e||"Unnamed bookmark",description:t}}}),n=await o.getLayout();return b(),n},destroyBookmark:async e=>{const t=await u.current.destroyBookmark({qId:e});return b(),t},getBookmark:d,getBookmarkLayout:async e=>{const t=await u.current.getBookmark({qId:e});return await t.getLayout()},updateBookmark:async(e,t,r)=>{const o=await d(e);await o.setProperties({qProp:{qInfo:{qId:e,qType:"bookmark"},qMetaDef:{title:t,description:r}}}),b()},error:q})};export{p as EngineContext,h as Login,I as Motor,L as NotConnected,qe as useApp,pe as useBookmark,ee as useButton,le as useCapability,$ as useData,w as useEngine,X as useGlobal,N as useHyperCube,ce as useLayout,A as useList,te as useSearch,ne as useSelections,G as useTable,de as useVariable};
//# sourceMappingURL=index.modern.js.map
